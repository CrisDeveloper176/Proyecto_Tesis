{% extends 'TemplatesBase/Base.html' %}
{% block content %}

<div class="container mt-5">
    <h1 class="mb-4 text-center">Gestión de Mantenimientos de Vehículos</h1>

    <div class="card shadow-lg">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Lista de Mantenimientos de Vehículos</h5>
                <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#addModal">
                    <i class="fas fa-plus-circle"></i> Agregar Mantenimiento
                </button>
            </div>
        </div>
        <div class="card-body">
            <p class="text-muted">Administra los mantenimientos registrados en el sistema.</p>
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Matricula</th>
                            <th>Tipo de Mantenimiento</th>
                            <th>Fecha Inicio</th>
                            <th>Fecha Fin</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="mantenimiento-table-body">
                        <!-- Los mantenimientos se llenarán dinámicamente -->
                        <tr>
                            <td colspan="5" class="text-center">Cargando...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Agregar -->
<div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addModalLabel">Agregar Mantenimiento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="vehiculo-select" class="form-label">Vehículo</label>
                    <select class="form-select" id="vehiculo-select" required>
                        <!-- Aquí se llenarán los vehículos con JavaScript -->
                    </select>
                </div>
                <div class="mb-3">
                    <label for="tipomantenimiento-select" class="form-label">Tipo de Mantenimiento</label>
                    <select class="form-select" id="tipomantenimiento-select" required>
                        <!-- Aquí se llenarán los tipos de mantenimiento con JavaScript -->
                    </select>
                </div>
                <div class="mb-3">
                    <label for="fecha-inicio" class="form-label">Fecha de Inicio</label>
                    <input type="datetime-local" class="form-control" id="fecha-inicio-input" required>
                </div>
                <div class="mb-3">
                    <label for="fecha-fin" class="form-label">Fecha de Fin</label>
                    <input type="datetime-local" class="form-control" id="fecha-fin-input">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="add-mantenimiento-button">Agregar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Editar -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Editar Mantenimiento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="edit-vehiculo" class="form-label">Vehículo</label>
                    <input type="text" class="form-control" id="edit-vehiculo-input" required>
                </div>
                <div class="mb-3">
                    <label for="edit-tipo-mantenimiento" class="form-label">Tipo de Mantenimiento</label>
                    <input type="text" class="form-control" id="edit-tipo-mantenimiento-input" required>
                </div>
                <div class="mb-3">
                    <label for="edit-fecha-inicio" class="form-label">Fecha de Inicio</label>
                    <input type="datetime-local" class="form-control" id="edit-fecha-inicio-input" required>
                </div>
                <div class="mb-3">
                    <label for="edit-fecha-fin" class="form-label">Fecha de Fin</label>
                    <input type="datetime-local" class="form-control" id="edit-fecha-fin-input">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="edit-mantenimiento-button">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Eliminar -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Eliminar Mantenimiento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas eliminar este mantenimiento?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="delete-mantenimiento-button">Eliminar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>


 const VEHICULO_API_URL = 'https://apitesis.fly.dev/api/v1/vehiculo/';
 const API_URL = 'https://apitesis.fly.dev/api/v1/TipoMantenimiento/';
 const MANTENIMIENTO_API_URL = 'https://apitesis.fly.dev/api/v1/Mantenimiento_Vehiculo/';


// Función para ajustar la fecha al formato UTC sin hora
function ajustarFechaUTC(fecha) {
    const fechaObj = new Date(fecha);
    return new Date(fechaObj.getTime() + fechaObj.getTimezoneOffset() * 60000).toISOString().split('T')[0];
}

// Formatear fecha para mostrarla correctamente en la tabla
const formatFecha = (fechaIso) => {
    if (!fechaIso) return 'N/A';
    const fecha = new Date(fechaIso);
    const fechaUTC = new Date(fecha.getTime() + fecha.getTimezoneOffset() * 60000);
    return fechaUTC.toLocaleDateString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit' });
};




    const loadVehiculo = async () => {
        const vehiculoSelect = document.getElementById('vehiculo-select');
        const editVehiculoSelect = document.getElementById('edit-vehiculo-input');
        vehiculoSelect.innerHTML = '<option value="">Seleccione un vehiculo</option>';
        editVehiculoSelect.innerHTML = '<option value="">Seleccione un vehiculo</option>';
        try {
            const response = await fetch(VEHICULO_API_URL);
            const vehiculos = await response.json();
            vehiculos.forEach((vehiculo) => {
                const option = `<option value="${vehiculo.ID_Vehiculo}">${vehiculo.Matricula}</option>`;
                vehiculoSelect.innerHTML += option;
                editVehiculoSelect.innerHTML += option;
            });
        } catch (error) {
            console.error('Error al cargar vehiculos:', error);
        }
    };

    const loadTipoMantenimiento = async () => {
        const mantenimientoSelect = document.getElementById('tipomantenimiento-select');
        const editMantenimientoSelect = document.getElementById('edit-tipo-mantenimiento-input');
        mantenimientoSelect.innerHTML = '<option value="">Seleccione un Tipo Mantenimiento</option>';
        editMantenimientoSelect.innerHTML = '<option value="">Seleccione un Tipo Mantenimiento</option>';
        try {
            const response = await fetch(API_URL);
            const mantenimientos = await response.json();
            mantenimientos.forEach((mantenimiento) => {
                const option = `<option value="${mantenimiento.ID_Mantenimiento }">${mantenimiento.Tipo_Mantenimiento }</option>`;
                mantenimientoSelect.innerHTML += option;
                editMantenimientoSelect.innerHTML += option;
            });
        } catch (error) {
            console.error('Error al cargar Tipo Mantenimiento:', error);
        }
    };



    const loadMantenimiento = async () => {
        const tbody = document.getElementById('mantenimiento-table-body');
        tbody.innerHTML = '';
        try {
            const response = await fetch(MANTENIMIENTO_API_URL);
            if (!response.ok) throw new Error('Error al cargar los mantenimientos');
            const mantenimientos = await response.json();

            mantenimientos.forEach((mantenimiento) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${mantenimiento.id}</td>
                    <td>${mantenimiento.ID_Mantenimiento}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="openEditModal(${mantenimiento.id}, '${mantenimiento.ID_Mantenimiento}')">Editar</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteMarca(${mantenimiento.id})">Eliminar</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        } catch (error) {
            Swal.fire('Error', 'No se pudieron cargar los mantenimientos.', 'error');
        }
    };




    const saveMantenimiento = async () => {
        const matriculaInput = document.getElementById('matricula');
        const tipo_mantenimientoInput = document.getElementById('tipo_mantenimiento');
        const fecha_inicioInput = document.getElementById('fecha_inicio');
        const fecha_finInput = document.getElementById('fecha_fin');
        

        try {
            const response = await fetch(MANTENIMIENTO_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ ID_Vehiculo: Matricula, ID_Mantenimiento: Tipo_Mantenimiento, Fecha_Inicio, Fecha_Fin }),
            });

            if (!response.ok) throw new Error('Error al guardar el mantenimiento');
            Swal.fire('Éxito', 'Mantenimiento agregado exitosamente.', 'success');
            mantenimientoInput.value = '';
            loadMantenimiento();
            document.querySelector('#addModal .btn-close').click();
        } catch (error) {
            Swal.fire('Error', 'No se pudo guardar el mantenimiento.', 'error');
        }
    };


    document.getElementById('add-mantenimiento-button').addEventListener('click', saveMantenimiento);
    ({
    });










    document.addEventListener('DOMContentLoaded', () => {
        loadVehiculo();
        loadTipoMantenimiento();
    });


    
</script>

{% endblock %}