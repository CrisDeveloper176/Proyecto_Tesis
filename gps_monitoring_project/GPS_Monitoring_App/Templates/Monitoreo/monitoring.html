{% extends 'TemplatesBase/Base.html' %}

{% block content %}
<!-- Contenedor principal que ocupa toda la pantalla para el mapa -->
<div class="container-fluid position-relative vh-100 p-0">
    <!-- Contenedor del mapa -->
    <div id="map" class="w-100 h-100"></div>

    <!-- Menú flotante en la esquina superior izquierda para la lista de vehículos -->
    <div class="position-absolute top-0 start-0 m-3">
        <div class="dropdown">
            <button class="btn btn-primary dropdown-toggle w-100" type="button" id="vehicleDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                Vehículos disponibles
            </button>
            <ul class="dropdown-menu" aria-labelledby="vehicleDropdown" style="max-height: 200px; overflow-y: auto;">
                <li><a class="dropdown-item" href="#">Vehículo 1</a></li>
                <li><a class="dropdown-item" href="#">Vehículo 2</a></li>
                <li><a class="dropdown-item" href="#">Vehículo 3</a></li>
                <!-- Agrega más vehículos según sea necesario -->
            </ul>
        </div>
    </div>

    <!-- Menú flotante en la esquina superior derecha para información del vehículo -->
    <div class="position-absolute top-0 end-0 m-3">
        <div class="dropdown">
            <button class="btn btn-primary dropdown-toggle w-100" type="button" id="infoDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                Información del Vehículo
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="infoDropdown" style="width: 250px;">
                <p><strong>Velocidad:</strong> <span>-- km/h</span></p>
                <p><strong>Tiempo de parada:</strong> <span>-- min</span></p>
                <p><strong>Matrícula:</strong> <span>--</span></p>
                <button class="btn btn-danger w-100 mt-2">Parar motor</button>
            </div>
        </div>
    </div>
</div>
<!-- Inicialización de Google Maps -->
<script>
    let map; // Mapa de Google
    let marker; // Marcador de Google Maps

    function initMap() {
        // Opciones del mapa
        const mapOptions = {
            zoom: 12,
            center: { lat: -37.4667, lng: -72.5667 } // Coordenadas iniciales (Laja y Huepil)
        };

        // Inicializar el mapa
        map = new google.maps.Map(document.getElementById("map"), mapOptions);

        // Crear marcador inicial
        marker = new google.maps.Marker({
            position: mapOptions.center,
            map: map,
            title: "Ubicación actual"
        });

        // Actualizar ubicación automáticamente
        function sendLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;

                    // Actualizar marcador en el mapa
                    const newPosition = { lat, lng };
                    marker.setPosition(newPosition);
                    map.setCenter(newPosition);

                    // Enviar ubicación al servidor
                    fetch('/api/ubicaciones/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            latitud: lat,
                            longitud: lng,
                            identificador: 'ID_UNICO_TELEFONO'
                        })
                    })
                    .then(response => {
                        if (response.ok) {
                            document.getElementById('status').innerText = "Estado: Ubicación enviada.";
                        } else {
                            document.getElementById('status').innerText = "Estado: Error al enviar ubicación.";
                        }
                    })
                    .catch(error => {
                        console.error('Error al enviar ubicación:', error);
                        document.getElementById('status').innerText = "Estado: Error al enviar ubicación.";
                    });
                }, error => {
                    console.error('Error al obtener ubicación:', error);
                    document.getElementById('status').innerText = "Estado: No se pudo obtener la ubicación.";
                });
            } else {
                document.getElementById('status').innerText = "Estado: Geolocalización no compatible.";
            }
        }

        // Ejecutar cada 500 ms
        setInterval(sendLocation, 500);
    }
</script>

<!-- Cargar la API de Google Maps -->
<script async defer
    src="https://maps.googleapis.com/maps/api/js?key=TU_API_KEY&callback=initMap">
</script>


{% endblock %}
